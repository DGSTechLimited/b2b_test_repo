name: GRES B2B Governance

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  governance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download gres-b2b CLI
        run: |
          set -euo pipefail
          VERSION="v4.0.0-beta.1"
          ZIP="gres-digital-b2b-${VERSION}.zip"
          URL="https://github.com/ajranjith/B2B-Updated/releases/download/${VERSION}/${ZIP}"
          curl -fsSL "$URL" -o "$ZIP"
          python - <<'PY'
          import shutil
          import zipfile
          from pathlib import Path, PurePosixPath

          zip_path = Path("gres-digital-b2b-v4.0.0-beta.1.zip")
          out_dir = Path("gres-b2b")
          out_dir.mkdir(exist_ok=True)

          with zipfile.ZipFile(zip_path) as zf:
            for info in zf.infolist():
              name = info.filename.replace("\\", "/")
              if name.endswith("/"):
                continue
              parts = PurePosixPath(name).parts
              if parts and parts[0].startswith("gres-digital-b2b-"):
                rel = Path(*parts[1:]) if len(parts) > 1 else Path()
              else:
                rel = Path(*parts)
              if not rel:
                continue
              target = out_dir / rel
              target.parent.mkdir(parents=True, exist_ok=True)
              with zf.open(info) as src, open(target, "wb") as dst:
                shutil.copyfileobj(src, dst)
          PY

      - name: Run GRES B2B Governance (Shadow)
        run: |
          set -euo pipefail
          chmod +x gres-b2b/bin/gres-b2b-linux-amd64
          python - <<'PY'
          import json
          import subprocess
          import time
          import sys
          
          cmd = ["./gres-b2b/bin/gres-b2b-linux-amd64"]
          proc = subprocess.Popen(
              cmd,
              stdin=subprocess.PIPE,
              stdout=subprocess.PIPE,
              stderr=subprocess.PIPE,
              text=True,
          )
          
          def send(msg):
            proc.stdin.write(json.dumps(msg) + "\n")
            proc.stdin.flush()
          
          def recv_json(timeout=10):
            start = time.time()
            while time.time() - start < timeout:
              line = proc.stdout.readline()
              if not line:
                time.sleep(0.05)
                continue
              line = line.strip()
              if not line:
                continue
              try:
                return json.loads(line)
              except json.JSONDecodeError:
                continue
            return None
          
          # Initialize MCP session (best-effort)
          send({
            "jsonrpc": "2.0",
            "id": 1,
            "method": "initialize",
            "params": {
              "protocolVersion": "2024-11-05",
              "clientInfo": {"name": "ci", "version": "1.0"},
              "capabilities": {}
            }
          })
          recv_json(timeout=5)
          send({"jsonrpc": "2.0", "method": "initialized", "params": {}})
          
          # Run brownfield scan
          send({
            "jsonrpc": "2.0",
            "id": 2,
            "method": "tools/call",
            "params": {"name": "b2b_scan_brownfield", "arguments": {"scan_path": "."}}
          })
          resp = recv_json(timeout=60)
          if not resp:
            stderr = proc.stderr.read()
            raise SystemExit(f"gres-b2b did not respond to tools/call. stderr:\\n{stderr}")
          if "error" in resp:
            raise SystemExit(f"gres-b2b error: {resp['error']}")
          
          proc.terminate()
          PY

      - name: Upload governance reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gres-b2b-reports
          path: |
            .b2b/report.html
            .b2b/report.json
