generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  DEALER
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

enum DealerStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum PricingTier {
  A
  B
  C
  D
  E
  F
}

enum PartType {
  AFTERMARKET
  GENUINE
  BRANDED
}

enum UploadType {
  PARTS_AFTERMARKET
  PARTS_GENUINE
  SUPERSESSION
  ORDER_STATUS
}

enum UploadStatus {
  PENDING
  APPLIED
  REJECTED
}

enum OrderStatus {
  SUSPENDED
  ON_HOLD
  PROCESSING
  SHIPPED
  COMPLETED
  CANCELLED
}

enum OrderItemStatus {
  PENDING
  PARTIALLY_SHIPPED
  SHIPPED
  BACKORDERED
  CANCELLED
}

enum OrderLineStatusState {
  OPEN
  PARTIALLY_FULFILLED
  BACKORDERED
  FULFILLED
  CANCELLED
}

model User {
  id                 String         @id @default(uuid())
  email              String         @unique
  passwordHash       String         @map("password_hash")
  role               Role
  status             UserStatus     @default(ACTIVE)
  name               String
  createdByUserId    String?        @map("created_by_user_id")
  lastLoginAt        DateTime?      @map("last_login_at")
  mustChangePassword Boolean        @default(true) @map("must_change_password")
  passwordUpdatedAt  DateTime?      @map("password_updated_at")
  createdAt          DateTime       @default(now()) @map("created_at")
  updatedAt          DateTime       @updatedAt @map("updated_at")
  createdBy          User?          @relation("CreatedBy", fields: [createdByUserId], references: [id])
  createdUsers       User[]         @relation("CreatedBy")
  dealerProfile      DealerProfile?
  cart               Cart?
  orders             Order[]
  uploadBatches      UploadBatch[]
  auditLogs          AuditLog[]

  @@index([email])
  @@index([role, status])
}

model DealerProfile {
  id                    String      @id @default(uuid())
  userId                String      @unique @map("user_id")
  accountNo             String      @unique @map("account_no")
  dealerName            String      @map("dealer_name")
  status                DealerStatus @default(ACTIVE)
  genuineTier           PricingTier @map("genuine_tier")
  aftermarketTier       PricingTier @map("aftermarket_tier")
  brandedTier           PricingTier @map("branded_tier")
  dispatchMethodDefault String?     @map("dispatch_method_default")
  createdAt             DateTime    @default(now()) @map("created_at")
  updatedAt             DateTime    @updatedAt @map("updated_at")
  user                  User        @relation(fields: [userId], references: [id])

  @@index([accountNo])
  @@index([status])
}

model UploadBatch {
  id                   String                @id @default(uuid())
  type                 UploadType
  filename             String
  status               UploadStatus          @default(PENDING)
  errorCsvPath         String?
  uploadedById         String
  createdAt            DateTime              @default(now())
  uploadedBy           User                  @relation(fields: [uploadedById], references: [id])
  stagingParts         StagingPart[]
  stagingSupersessions StagingSupersession[]
  stagingOrderStatuses StagingOrderStatus[]
  orderLineStatuses    OrderLineStatus[]
}

model StagingPart {
  id              String      @id @default(uuid())
  batchId         String
  rowNumber       Int
  partType        PartType
  manufacturer    String?
  stkNo           String?
  landRoverNo     String?
  jaguarNo        String?
  supplier        String?
  brand           String?
  oem             String?
  description     String?
  freeStock       String?
  tradePrice      String?
  bandA           String?
  bandB           String?
  bandC           String?
  bandD           String?
  bandE           String?
  bandF           String?
  minimumPrice    String?
  tariffCode      String?
  countryOfOrigin String?
  barcode         String?
  raw             Json
  batch           UploadBatch @relation(fields: [batchId], references: [id])

  @@index([batchId])
  @@index([stkNo])
}

model CatalogPart {
  id              String      @id @default(uuid())
  stkNo           String      @unique
  manufacturer    String
  landRoverNo     String?
  jaguarNo        String?
  supplier        String?
  brand           String?
  oem             String?
  description     String?
  freeStock       Int
  tradePrice      Decimal     @db.Decimal(12, 2)
  bandA           Decimal     @db.Decimal(12, 2)
  bandB           Decimal     @db.Decimal(12, 2)
  bandC           Decimal     @db.Decimal(12, 2)
  bandD           Decimal     @db.Decimal(12, 2)
  bandE           Decimal     @db.Decimal(12, 2)
  bandF           Decimal     @db.Decimal(12, 2)
  minimumPrice    Decimal     @db.Decimal(12, 2)
  tariffCode      String?
  countryOfOrigin String?
  barcode         String?
  imageUrl        String?
  partType        PartType
  isActive        Boolean     @default(true)
  lastSeenAt      DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  orderItems      OrderItem[]
  cartItems       CartItem[]

  @@index([stkNo])
  @@index([manufacturer])
  @@index([supplier])
  @@index([brand])
  @@index([oem])
  @@index([landRoverNo])
  @@index([jaguarNo])
  @@index([description])
  @@index([barcode])
}

model Supersession {
  id            String    @id @default(uuid())
  oldPartNo     String    @unique
  newPartNo     String
  reason        String?
  effectiveDate DateTime?
  createdAt     DateTime  @default(now())
}

model StagingSupersession {
  id            String      @id @default(uuid())
  batchId       String
  rowNumber     Int
  oldPartNo     String?
  newPartNo     String?
  reason        String?
  effectiveDate String?
  raw           Json
  batch         UploadBatch @relation(fields: [batchId], references: [id])

  @@index([batchId])
}

model StagingOrderStatus {
  id             String      @id @default(uuid())
  batchId        String
  rowNumber      Int
  orderNumber    String?
  accountNo      String?
  partNumber     String?
  orderedQty     String?
  fulfilledQty   String?
  backorderedQty String?
  status         String?
  statusDate     String?
  notes          String?
  raw            Json
  batch          UploadBatch @relation(fields: [batchId], references: [id])

  @@index([batchId])
}

model OrderLineStatus {
  id             String               @id @default(uuid())
  orderId        String
  accountNo      String
  partNumber     String
  orderedQty     Int
  fulfilledQty   Int?
  backorderedQty Int?
  status         OrderLineStatusState
  statusDate     DateTime
  notes          String?
  sourceBatchId  String?
  createdAt      DateTime             @default(now())
  order          Order                @relation(fields: [orderId], references: [id])
  sourceBatch    UploadBatch?         @relation(fields: [sourceBatchId], references: [id])

  @@unique([orderId, partNumber])
  @@index([accountNo])
  @@index([status])
}

model Cart {
  id        String     @id @default(uuid())
  userId    String     @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  user      User       @relation(fields: [userId], references: [id])
  items     CartItem[]
}

model CartItem {
  id          String       @id @default(uuid())
  cartId      String
  partId      String?
  partStkNo   String
  description String?
  qty         Int
  unitPrice   Decimal      @db.Decimal(12, 2)
  lineTotal   Decimal      @db.Decimal(12, 2)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  cart        Cart         @relation(fields: [cartId], references: [id])
  part        CatalogPart? @relation(fields: [partId], references: [id])

  @@index([cartId])
}

model Order {
  id              String            @id @default(uuid())
  orderNumber     String            @unique
  userId          String
  dealerAccountNo String
  shippingMethod  String?           @map("shipping_method")
  poNumber        String?           @map("po_number")
  orderNote       String?           @map("order_note")
  contactFirstName String?          @map("contact_first_name")
  contactLastName  String?          @map("contact_last_name")
  contactEmail     String?          @map("contact_email")
  status          OrderStatus
  currency        String            @default("GBP")
  totalAmount     Decimal           @db.Decimal(12, 2)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  user            User              @relation(fields: [userId], references: [id])
  items           OrderItem[]
  lineStatuses    OrderLineStatus[]

  @@index([orderNumber])
}

model OrderItem {
  id             String          @id @default(uuid())
  orderId        String
  partId         String?
  partStkNo      String
  description    String?
  qty            Int
  unitPrice      Decimal         @db.Decimal(12, 2)
  lineTotal      Decimal         @db.Decimal(12, 2)
  priceTier      PricingTier
  priceCategory  PartType
  status         OrderItemStatus @default(PENDING)
  shippedQty     Int?
  backorderedQty Int?
  trackingNo     String?
  etaDate        DateTime?
  updatedAt      DateTime        @updatedAt
  order          Order           @relation(fields: [orderId], references: [id])
  part           CatalogPart?    @relation(fields: [partId], references: [id])

  @@index([orderId])
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  action    String
  metadata  Json?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])
}
